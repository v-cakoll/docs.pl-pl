---
title: Obsługa komunikatów zanieczyszczonych
ms.date: 03/30/2017
ms.assetid: 8d1c5e5a-7928-4a80-95ed-d8da211b8595
ms.openlocfilehash: d219c18bb072684deb6cc1d8a2d17b1989762151
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 06/09/2020
ms.locfileid: "84590569"
---
# <a name="poison-message-handling"></a><span data-ttu-id="2d941-102">Obsługa komunikatów zanieczyszczonych</span><span class="sxs-lookup"><span data-stu-id="2d941-102">Poison Message Handling</span></span>
<span data-ttu-id="2d941-103">*Trująca wiadomość* jest komunikatem, który przekroczył maksymalną liczbę prób dostarczenia do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-103">A *poison message* is a message that has exceeded the maximum number of delivery attempts to the application.</span></span> <span data-ttu-id="2d941-104">Taka sytuacja może wystąpić, gdy aplikacja oparta na kolejce nie może przetworzyć komunikatu z powodu błędów.</span><span class="sxs-lookup"><span data-stu-id="2d941-104">This situation can arise when a queue-based application cannot process a message because of errors.</span></span> <span data-ttu-id="2d941-105">Aby spełnić wymagania dotyczące niezawodności, aplikacja umieszczona w kolejce odbiera komunikaty w ramach transakcji.</span><span class="sxs-lookup"><span data-stu-id="2d941-105">To meet reliability demands, a queued application receives messages under a transaction.</span></span> <span data-ttu-id="2d941-106">Przerwanie transakcji, w której otrzymano komunikat w kolejce, pozostawia komunikat w kolejce, aby komunikat został ponowiony w ramach nowej transakcji.</span><span class="sxs-lookup"><span data-stu-id="2d941-106">Aborting the transaction in which a queued message was received leaves the message in the queue so that the message is retried under a new transaction.</span></span> <span data-ttu-id="2d941-107">Jeśli problem, który spowodował przerwanie transakcji, nie zostanie poprawiony, aplikacja otrzymująca może zostać zablokowana w pętli, która odbiera i przerywa ten sam komunikat do momentu przekroczenia maksymalnej liczby prób dostarczenia i zatrucia wyników komunikatów.</span><span class="sxs-lookup"><span data-stu-id="2d941-107">If the problem that caused the transaction to abort is not corrected, the receiving application can get stuck in a loop receiving and aborting the same message until the maximum number of delivery attempts has been exceeded and a poison message results.</span></span>  
  
 <span data-ttu-id="2d941-108">Komunikat może być skażony z wielu powodów.</span><span class="sxs-lookup"><span data-stu-id="2d941-108">A message can become a poison message for many reasons.</span></span> <span data-ttu-id="2d941-109">Najczęstszymi przyczynami są specyficzne dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-109">The most common reasons are application-specific.</span></span> <span data-ttu-id="2d941-110">Na przykład, jeśli aplikacja odczytuje komunikat z kolejki i wykonuje przetwarzanie bazy danych, aplikacja może nie można uzyskać blokady bazy danych, powodując przerwanie transakcji.</span><span class="sxs-lookup"><span data-stu-id="2d941-110">For example, if an application reads a message from a queue and performs some database processing, the application may fail to get a lock on the database, causing it to abort the transaction.</span></span> <span data-ttu-id="2d941-111">Ponieważ transakcja bazy danych została przerwana, komunikat pozostaje w kolejce, co powoduje, że aplikacja może ponownie odczytać komunikat po raz drugi i podjąć kolejną próbę uzyskania blokady bazy danych.</span><span class="sxs-lookup"><span data-stu-id="2d941-111">Because the database transaction was aborted, the message remains in the queue, which causes the application to reread the message a second time and make another attempt to acquire a lock on the database.</span></span> <span data-ttu-id="2d941-112">Komunikaty mogą również stać się trujące, jeśli zawierają nieprawidłowe informacje.</span><span class="sxs-lookup"><span data-stu-id="2d941-112">Messages can also become poison if they contain invalid information.</span></span> <span data-ttu-id="2d941-113">Na przykład zamówienie zakupu może zawierać nieprawidłowy numer klienta.</span><span class="sxs-lookup"><span data-stu-id="2d941-113">For example, a purchase order may contain an invalid customer number.</span></span> <span data-ttu-id="2d941-114">W takich przypadkach aplikacja może dobrowolnie przerwać transakcję i wymusić, aby komunikat stał się skażonym komunikatem.</span><span class="sxs-lookup"><span data-stu-id="2d941-114">In these cases, the application may voluntarily abort the transaction and force the message to become a poison message.</span></span>  
  
 <span data-ttu-id="2d941-115">W rzadkich przypadkach komunikaty mogą nie być wysyłane do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-115">On rare occasions, messages can fail to get dispatched to the application.</span></span> <span data-ttu-id="2d941-116">Warstwa Windows Communication Foundation (WCF) może znaleźć problem z komunikatem, na przykład jeśli komunikat ma złą ramkę, dołączono do niego nieprawidłowe poświadczenia wiadomości lub nieprawidłowy nagłówek akcji.</span><span class="sxs-lookup"><span data-stu-id="2d941-116">The Windows Communication Foundation (WCF) layer may find a problem with the message, such as if the message has the wrong frame, invalid message credentials attached to it, or an invalid action header.</span></span> <span data-ttu-id="2d941-117">W takich przypadkach aplikacja nigdy nie otrzymuje komunikatu; Jednak komunikat nadal może stać się skażony i być przetwarzany ręcznie.</span><span class="sxs-lookup"><span data-stu-id="2d941-117">In these cases, the application never receives the message; however, the message can still become a poison message and be processed manually.</span></span>  
  
## <a name="handling-poison-messages"></a><span data-ttu-id="2d941-118">Obsługa skażonych komunikatów</span><span class="sxs-lookup"><span data-stu-id="2d941-118">Handling Poison Messages</span></span>  
 <span data-ttu-id="2d941-119">W programie WCF Obsługa skażonych komunikatów zapewnia mechanizm do otrzymywania aplikacji, które nie mogą być wysyłane do aplikacji lub komunikatów wysyłanych do aplikacji, ale nie można ich przetworzyć z powodu powodów specyficznych dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-119">In WCF, poison message handling provides a mechanism for a receiving application to deal with messages that cannot be dispatched to the application or messages that are dispatched to the application but that fail to be processed because of application-specific reasons.</span></span> <span data-ttu-id="2d941-120">Skonfiguruj obsługę skażonych komunikatów z następującymi właściwościami w każdym z dostępnych w kolejce powiązań:</span><span class="sxs-lookup"><span data-stu-id="2d941-120">Configure poison message handling with the following properties in each of the available queued bindings:</span></span>  
  
- <span data-ttu-id="2d941-121">`ReceiveRetryCount`.</span><span class="sxs-lookup"><span data-stu-id="2d941-121">`ReceiveRetryCount`.</span></span> <span data-ttu-id="2d941-122">Wartość całkowita wskazująca maksymalną liczbę ponownych prób dostarczenia komunikatu z kolejki aplikacji do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-122">An integer value that indicates the maximum number of times to retry delivery of a message from the application queue to the application.</span></span> <span data-ttu-id="2d941-123">Wartość domyślna to 5.</span><span class="sxs-lookup"><span data-stu-id="2d941-123">The default value is 5.</span></span> <span data-ttu-id="2d941-124">Jest to wystarczające w przypadkach, gdy natychmiastowa ponowna próba rozwiązuje problem, na przykład przez tymczasowe zakleszczenie w bazie danych.</span><span class="sxs-lookup"><span data-stu-id="2d941-124">This is sufficient in cases where an immediate retry fixes the problem, such as with a temporary deadlock on a database.</span></span>  
  
- <span data-ttu-id="2d941-125">`MaxRetryCycles`.</span><span class="sxs-lookup"><span data-stu-id="2d941-125">`MaxRetryCycles`.</span></span> <span data-ttu-id="2d941-126">Wartość całkowita, która wskazuje maksymalną liczbę ponownych prób.</span><span class="sxs-lookup"><span data-stu-id="2d941-126">An integer value that indicates the maximum number of retry cycles.</span></span> <span data-ttu-id="2d941-127">Cykl ponowień polega na przesłaniu komunikatu z kolejki aplikacji do podrzędnej kolejki ponownych prób i po skonfigurowaniu opóźnienia z powrotem z kolejki ponownych prób w kolejce aplikacji w celu ponowienia próby dostarczenia.</span><span class="sxs-lookup"><span data-stu-id="2d941-127">A retry cycle consists of transferring a message from the application queue to the retry subqueue and, after a configurable delay, from the retry subqueue back into the application queue to reattempt delivery.</span></span> <span data-ttu-id="2d941-128">Wartość domyślna to 2.</span><span class="sxs-lookup"><span data-stu-id="2d941-128">The default value is 2.</span></span> <span data-ttu-id="2d941-129">W systemie Windows Vista komunikat próbuje maksymalnie ( `ReceiveRetryCount` + 1) \* ( `MaxRetryCycles` + 1) razy.</span><span class="sxs-lookup"><span data-stu-id="2d941-129">On Windows Vista, the message is tried a maximum of (`ReceiveRetryCount` +1) \* (`MaxRetryCycles` + 1) times.</span></span> <span data-ttu-id="2d941-130">`MaxRetryCycles`jest ignorowany w systemach Windows Server 2003 i Windows XP.</span><span class="sxs-lookup"><span data-stu-id="2d941-130">`MaxRetryCycles` is ignored on Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="2d941-131">`RetryCycleDelay`.</span><span class="sxs-lookup"><span data-stu-id="2d941-131">`RetryCycleDelay`.</span></span> <span data-ttu-id="2d941-132">Opóźnienie między cyklami ponawiania prób.</span><span class="sxs-lookup"><span data-stu-id="2d941-132">The time delay between retry cycles.</span></span> <span data-ttu-id="2d941-133">Wartość domyślna to 30 minut.</span><span class="sxs-lookup"><span data-stu-id="2d941-133">The default value is 30 minutes.</span></span> <span data-ttu-id="2d941-134">`MaxRetryCycles`i `RetryCycleDelay` razem zapewniają mechanizm rozwiązywania problemu, gdy ponowna próba po okresowym opóźnieniu rozwiązuje problem.</span><span class="sxs-lookup"><span data-stu-id="2d941-134">`MaxRetryCycles` and `RetryCycleDelay` together provide a mechanism to address the problem where a retry after a periodic delay fixes the problem.</span></span> <span data-ttu-id="2d941-135">Na przykład obsługuje zablokowany zestaw wierszy w SQL Server oczekujące zatwierdzenie transakcji.</span><span class="sxs-lookup"><span data-stu-id="2d941-135">For example, this handles a locked row set in SQL Server pending transaction commit.</span></span>  
  
- <span data-ttu-id="2d941-136">`ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="2d941-136">`ReceiveErrorHandling`.</span></span> <span data-ttu-id="2d941-137">Wyliczenie, które wskazuje akcję, która ma zostać podjęta dla komunikatu o niepomyślnym dostarczeniu po próbie przeprowadzenia maksymalnej liczby ponownych prób.</span><span class="sxs-lookup"><span data-stu-id="2d941-137">An enumeration that indicates the action to take for a message that has failed delivery after the maximum number of retries has been attempted.</span></span> <span data-ttu-id="2d941-138">Wartości mogą być błędne, porzucane, odrzucane i przenoszone.</span><span class="sxs-lookup"><span data-stu-id="2d941-138">The values can be Fault, Drop, Reject, and Move.</span></span> <span data-ttu-id="2d941-139">Opcja domyślna to Fault.</span><span class="sxs-lookup"><span data-stu-id="2d941-139">The default option is Fault.</span></span>  
  
- <span data-ttu-id="2d941-140">Powodu.</span><span class="sxs-lookup"><span data-stu-id="2d941-140">Fault.</span></span> <span data-ttu-id="2d941-141">Ta opcja wysyła błąd do odbiornika, który spowodował `ServiceHost` błąd.</span><span class="sxs-lookup"><span data-stu-id="2d941-141">This option sends a fault to the listener that caused the `ServiceHost` to fault.</span></span> <span data-ttu-id="2d941-142">Komunikat musi zostać usunięty z kolejki aplikacji przez pewien mechanizm zewnętrzny, aby aplikacja mogła kontynuować przetwarzanie komunikatów z kolejki.</span><span class="sxs-lookup"><span data-stu-id="2d941-142">The message must be removed from the application queue by some external mechanism before the application can continue to process messages from the queue.</span></span>  
  
- <span data-ttu-id="2d941-143">Listy rozwijanej.</span><span class="sxs-lookup"><span data-stu-id="2d941-143">Drop.</span></span> <span data-ttu-id="2d941-144">Ta opcja powoduje odrzucanie skażonych komunikatów, a komunikat nigdy nie jest dostarczany do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-144">This option drops the poison message and the message is never delivered to the application.</span></span> <span data-ttu-id="2d941-145">Jeśli `TimeToLive` w tym momencie Właściwość komunikatu wygasła, komunikat może się pojawić w kolejce utraconych wiadomości nadawcy.</span><span class="sxs-lookup"><span data-stu-id="2d941-145">If the message's `TimeToLive` property has expired at this point, then the message may appear in the sender's dead-letter queue.</span></span> <span data-ttu-id="2d941-146">Jeśli nie, komunikat nie pojawia się w dowolnym miejscu.</span><span class="sxs-lookup"><span data-stu-id="2d941-146">If not, the message does not appear anywhere.</span></span> <span data-ttu-id="2d941-147">Ta opcja oznacza, że użytkownik nie określił czynności, które należy wykonać, jeśli komunikat zostanie utracony.</span><span class="sxs-lookup"><span data-stu-id="2d941-147">This option indicates that the user has not specified what to do if the message is lost.</span></span>  
  
- <span data-ttu-id="2d941-148">Oznacza.</span><span class="sxs-lookup"><span data-stu-id="2d941-148">Reject.</span></span> <span data-ttu-id="2d941-149">Ta opcja jest dostępna tylko w systemie Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="2d941-149">This option is available only on Windows Vista.</span></span> <span data-ttu-id="2d941-150">Powoduje to zainstruujenie usługi kolejkowania komunikatów (MSMQ) w celu wysłania negatywnego potwierdzenia z powrotem do Menedżera kolejki wysyłania, którego aplikacja nie może odebrać komunikatu.</span><span class="sxs-lookup"><span data-stu-id="2d941-150">This instructs Message Queuing (MSMQ) to send a negative acknowledgment back to the sending queue manager that the application cannot receive the message.</span></span> <span data-ttu-id="2d941-151">Wiadomość zostanie umieszczona w kolejce utraconych wiadomości Menedżera kolejki wysyłania.</span><span class="sxs-lookup"><span data-stu-id="2d941-151">The message is placed in the sending queue manager's dead-letter queue.</span></span>  
  
- <span data-ttu-id="2d941-152">Przenieś.</span><span class="sxs-lookup"><span data-stu-id="2d941-152">Move.</span></span> <span data-ttu-id="2d941-153">Ta opcja jest dostępna tylko w systemie Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="2d941-153">This option is available only on Windows Vista.</span></span> <span data-ttu-id="2d941-154">Spowoduje to przeniesienie skażonego komunikatu do kolejki komunikatów trujących w celu późniejszego przetworzenia przez aplikację skażoną komunikatów.</span><span class="sxs-lookup"><span data-stu-id="2d941-154">This moves the poison message to a poison-message queue for later processing by a poison-message handling application.</span></span> <span data-ttu-id="2d941-155">"Trująca-komunikat" jest podkolejką kolejki aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-155">The poison-message queue is a subqueue of the application queue.</span></span> <span data-ttu-id="2d941-156">Aplikacja do obsługi komunikatów trujących może być usługą WCF, która odczytuje komunikaty z kolejki trującej.</span><span class="sxs-lookup"><span data-stu-id="2d941-156">A poison-message handling application can be a WCF service that reads messages out of the poison queue.</span></span> <span data-ttu-id="2d941-157">Kolejka Trująca jest podkolejką kolejki aplikacji i może być rozkierowane jako net. MSMQ:// \<*machine-name*> / *applicationQueue*;p Oison, gdzie *Machine-Name* to nazwa komputera, na którym znajduje się kolejka, a *applicationQueue* to nazwa kolejki specyficznej dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-157">The poison queue is a subqueue of the application queue and can be addressed as net.msmq://\<*machine-name*>/*applicationQueue*;poison, where *machine-name* is the name of the computer on which the queue resides and the *applicationQueue* is the name of the application-specific queue.</span></span>  
  
<span data-ttu-id="2d941-158">Poniżej przedstawiono maksymalną liczbę prób dostarczenia komunikatu:</span><span class="sxs-lookup"><span data-stu-id="2d941-158">The following are the maximum number of delivery attempts made for a message:</span></span>  
  
- <span data-ttu-id="2d941-159">((ReceiveRetryCount + 1) \* (MaxRetryCycles + 1)) w systemie Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="2d941-159">((ReceiveRetryCount+1) \* (MaxRetryCycles + 1)) on Windows Vista.</span></span>  
  
- <span data-ttu-id="2d941-160">(ReceiveRetryCount + 1) w systemie Windows Server 2003 i Windows XP.</span><span class="sxs-lookup"><span data-stu-id="2d941-160">(ReceiveRetryCount + 1) on Windows Server 2003 and Windows XP.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="2d941-161">Nie wykonano żadnych ponownych prób dla wiadomości, która została dostarczona pomyślnie.</span><span class="sxs-lookup"><span data-stu-id="2d941-161">No retries are made for a message that is delivered successfully.</span></span>  
  
 <span data-ttu-id="2d941-162">Aby śledzić liczbę prób odczytu komunikatu, system Windows Vista utrzymuje trwałą Właściwość komunikatu, która zlicza liczbę przerwań i Właściwość liczby przeniesień, która zlicza, ile razy komunikat przechodzi między kolejką aplikacji a podkolejkami.</span><span class="sxs-lookup"><span data-stu-id="2d941-162">To keep track of the number of times a message read is attempted, Windows Vista maintains a durable message property that counts the number of aborts and a move count property that counts the number of times the message moves between the application queue and subqueues.</span></span> <span data-ttu-id="2d941-163">Kanał WCF używa tych funkcji do obliczenia liczby ponowień odbioru i liczby ponownych prób.</span><span class="sxs-lookup"><span data-stu-id="2d941-163">The WCF channel uses these to compute the receive retry count and the retry cycles count.</span></span> <span data-ttu-id="2d941-164">W systemach Windows Server 2003 i Windows XP licznik przerwań jest zachowywany w pamięci przez kanał WCF i jest resetowany w przypadku niepowodzenia aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-164">On Windows Server 2003 and Windows XP, the abort count is maintained in memory by the WCF channel and is reset if the application fails.</span></span> <span data-ttu-id="2d941-165">Ponadto kanał WCF może w dowolnym momencie przechowywać liczbę przerwań dla maksymalnie 256 komunikatów w pamięci.</span><span class="sxs-lookup"><span data-stu-id="2d941-165">Also, the WCF channel can hold the abort counts for up to 256 messages in memory at any time.</span></span> <span data-ttu-id="2d941-166">Jeśli zostanie odczytany komunikat 257th, licznik przerwań najstarszej wiadomości zostanie zresetowany.</span><span class="sxs-lookup"><span data-stu-id="2d941-166">If a 257th message is read, then the oldest message's abort count is reset.</span></span>  
  
 <span data-ttu-id="2d941-167">Właściwości liczba przerwań i liczba operacji przenoszenia są dostępne dla operacji usługi za pomocą kontekstu operacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-167">The abort count and move count properties are available to the service operation through the operation context.</span></span> <span data-ttu-id="2d941-168">Poniższy przykład kodu pokazuje, jak uzyskać do nich dostęp.</span><span class="sxs-lookup"><span data-stu-id="2d941-168">The following code example shows how to access them.</span></span>  
  
 [!code-csharp[S_UE_MSMQ_Poison#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/service.cs#1)]  
  
 <span data-ttu-id="2d941-169">Funkcja WCF oferuje dwa standardowe powiązania kolejkowane:</span><span class="sxs-lookup"><span data-stu-id="2d941-169">WCF provides two standard queued bindings:</span></span>  
  
- <span data-ttu-id="2d941-170"><xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="2d941-170"><xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="2d941-171">Powiązanie .NET Framework odpowiednie do wykonywania komunikacji opartej na kolejce z innymi punktami końcowymi WCF.</span><span class="sxs-lookup"><span data-stu-id="2d941-171">A .NET Framework binding suitable for performing queue-based communication with other WCF endpoints.</span></span>  
  
- <span data-ttu-id="2d941-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span><span class="sxs-lookup"><span data-stu-id="2d941-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span></span> <span data-ttu-id="2d941-173">Powiązanie odpowiednie do komunikacji z istniejącymi aplikacjami usługi kolejkowania komunikatów.</span><span class="sxs-lookup"><span data-stu-id="2d941-173">A binding suitable for communicating with existing Message Queuing applications.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="2d941-174">Można zmienić właściwości w tych powiązaniach na podstawie wymagań usługi WCF.</span><span class="sxs-lookup"><span data-stu-id="2d941-174">You can alter properties in these bindings based on the requirements of your WCF service.</span></span> <span data-ttu-id="2d941-175">Cały mechanizm obsługi skażonych komunikatów jest lokalny dla aplikacji odbiorczej.</span><span class="sxs-lookup"><span data-stu-id="2d941-175">The entire poison message handling mechanism is local to the receiving application.</span></span> <span data-ttu-id="2d941-176">Ten proces jest niewidoczny dla aplikacji wysyłającej, chyba że aplikacja otrzymująca ostatecznie zatrzyma się i wyśle negatywną potwierdzenie z powrotem do nadawcy.</span><span class="sxs-lookup"><span data-stu-id="2d941-176">The process is invisible to the sending application unless the receiving application ultimately stops and sends a negative acknowledgment back to the sender.</span></span> <span data-ttu-id="2d941-177">W takim przypadku wiadomość zostanie przeniesiona do kolejki utraconych wiadomości nadawcy.</span><span class="sxs-lookup"><span data-stu-id="2d941-177">In that case, the message is moved to the sender's dead-letter queue.</span></span>  
  
## <a name="best-practice-handling-msmqpoisonmessageexception"></a><span data-ttu-id="2d941-178">Najlepsze rozwiązanie: Obsługa MsmqPoisonMessageException —</span><span class="sxs-lookup"><span data-stu-id="2d941-178">Best Practice: Handling MsmqPoisonMessageException</span></span>  
 <span data-ttu-id="2d941-179">Gdy usługa określa, że komunikat jest trująca, transport umieszczony w kolejce zgłasza, <xref:System.ServiceModel.MsmqPoisonMessageException> że zawiera `LookupId` komunikat trujący.</span><span class="sxs-lookup"><span data-stu-id="2d941-179">When the service determines that a message is poison, the queued transport throws a <xref:System.ServiceModel.MsmqPoisonMessageException> that contains the `LookupId` of the poison message.</span></span>  
  
 <span data-ttu-id="2d941-180">Aplikacja do odbioru może zaimplementować <xref:System.ServiceModel.Dispatcher.IErrorHandler> interfejs w celu obsługi wszystkich błędów wymaganych przez aplikację.</span><span class="sxs-lookup"><span data-stu-id="2d941-180">A receiving application can implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to handle any errors that the application requires.</span></span> <span data-ttu-id="2d941-181">Aby uzyskać więcej informacji, zobacz [Rozszerzanie kontroli nad obsługą błędów i raportowaniem](../samples/extending-control-over-error-handling-and-reporting.md).</span><span class="sxs-lookup"><span data-stu-id="2d941-181">For more information, see [Extending Control Over Error Handling and Reporting](../samples/extending-control-over-error-handling-and-reporting.md).</span></span>  
  
 <span data-ttu-id="2d941-182">Aplikacja może wymagać pewnego rodzaju automatycznej obsługi skażonych komunikatów, które przenosi trujące komunikaty do kolejki komunikatów trujących, aby usługa mogła uzyskać dostęp do pozostałych komunikatów w kolejce.</span><span class="sxs-lookup"><span data-stu-id="2d941-182">The application may require some kind of automated handling of poison messages that moves the poison messages to a poison message queue so that the service can access the rest of the messages in the queue.</span></span> <span data-ttu-id="2d941-183">Jedynym scenariuszem używania mechanizmu obsługi błędów do nasłuchiwania wyjątków komunikatów trujących jest <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> ustawienie wartość <xref:System.ServiceModel.ReceiveErrorHandling.Fault> .</span><span class="sxs-lookup"><span data-stu-id="2d941-183">The only scenario for using the error-handler mechanism to listen for poison-message exceptions is when the <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> setting is set to <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span></span> <span data-ttu-id="2d941-184">Przykładowy komunikat zatrucia dla usługi kolejkowania komunikatów 3,0 pokazuje to zachowanie.</span><span class="sxs-lookup"><span data-stu-id="2d941-184">The poison-message sample for Message Queuing 3.0 demonstrates this behavior.</span></span> <span data-ttu-id="2d941-185">Poniżej przedstawiono kroki, które należy wykonać, aby obsłużyć trujące komunikaty, w tym najlepsze rozwiązania:</span><span class="sxs-lookup"><span data-stu-id="2d941-185">The following outlines the steps to take to handle poison messages, including best practices:</span></span>  
  
1. <span data-ttu-id="2d941-186">Upewnij się, że ustawienia trujące odzwierciedlają wymagania aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-186">Ensure your poison settings reflect the requirements of your application.</span></span> <span data-ttu-id="2d941-187">Podczas pracy z ustawieniami upewnij się, że rozumiesz różnice między możliwościami usługi kolejkowania komunikatów w systemach Windows Vista, Windows Server 2003 i Windows XP.</span><span class="sxs-lookup"><span data-stu-id="2d941-187">When working with the settings, ensure that you understand the differences between the capabilities of Message Queuing on Windows Vista, Windows Server 2003, and Windows XP.</span></span>  
  
2. <span data-ttu-id="2d941-188">W razie potrzeby Zaimplementuj, `IErrorHandler` Aby obsługiwać błędy trujących komunikatów.</span><span class="sxs-lookup"><span data-stu-id="2d941-188">If necessary, implement the `IErrorHandler` to handle poison-message errors.</span></span> <span data-ttu-id="2d941-189">Ponieważ ustawienie `ReceiveErrorHandling` `Fault` wymaga ręcznego mechanizmu przenoszenia skażonego komunikatu z kolejki lub do skorygowania zewnętrznego problemu zależnego, typowym użyciem jest zaimplementowanie `IErrorHandler` `ReceiveErrorHandling` , gdy jest ustawiony na `Fault` , jak pokazano w poniższym kodzie.</span><span class="sxs-lookup"><span data-stu-id="2d941-189">Because setting `ReceiveErrorHandling` to `Fault` requires a manual mechanism to move the poison message out of the queue or to correct an external dependent issue, the typical usage is to implement `IErrorHandler` when `ReceiveErrorHandling` is set to `Fault`, as shown in the following code.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonerrorhandler.cs#2)]  
  
3. <span data-ttu-id="2d941-190">Utwórz `PoisonBehaviorAttribute` , że można użyć zachowania usługi.</span><span class="sxs-lookup"><span data-stu-id="2d941-190">Create a `PoisonBehaviorAttribute` that the service behavior can use.</span></span> <span data-ttu-id="2d941-191">Zachowanie instaluje `IErrorHandler` w dyspozytorze.</span><span class="sxs-lookup"><span data-stu-id="2d941-191">The behavior installs the `IErrorHandler` on the dispatcher.</span></span> <span data-ttu-id="2d941-192">Zobacz Poniższy przykład kodu.</span><span class="sxs-lookup"><span data-stu-id="2d941-192">See the following code example.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonbehaviorattribute.cs#3)]  
  
4. <span data-ttu-id="2d941-193">Upewnij się, że Twoja usługa ma adnotację z atrybutem zachowania trujące.</span><span class="sxs-lookup"><span data-stu-id="2d941-193">Ensure that your service is annotated with the poison behavior attribute.</span></span>  

 <span data-ttu-id="2d941-194">Ponadto, jeśli `ReceiveErrorHandling` jest ustawiona na `Fault` , `ServiceHost` błędy podczas napotkania skażonego komunikatu.</span><span class="sxs-lookup"><span data-stu-id="2d941-194">In addition, if the `ReceiveErrorHandling` is set to `Fault`, the `ServiceHost` faults when encountering the poison message.</span></span> <span data-ttu-id="2d941-195">Można podłączyć do uszkodzonego zdarzenia i zamknąć usługę, podejmować działania naprawcze i ponownie uruchomić.</span><span class="sxs-lookup"><span data-stu-id="2d941-195">You can hook up to the faulted event and shut down the service, take corrective actions, and restart.</span></span> <span data-ttu-id="2d941-196">Na przykład, w odniesieniu `LookupId` do, można zauważyć, że w przypadku <xref:System.ServiceModel.MsmqPoisonMessageException> `IErrorHandler` awarii hosta usługi, możesz użyć `System.Messaging` interfejsu API, aby odebrać komunikat z kolejki za pomocą polecenia, `LookupId` Aby usunąć komunikat z kolejki i zapisać go w zewnętrznym magazynie lub innej kolejce.</span><span class="sxs-lookup"><span data-stu-id="2d941-196">For example, the `LookupId` in the <xref:System.ServiceModel.MsmqPoisonMessageException> propagated to the `IErrorHandler` can be noted and when the service host faults, you could use the `System.Messaging` API to receive the message from the queue using the `LookupId` to remove the message from the queue and store the message in some external store or another queue.</span></span> <span data-ttu-id="2d941-197">Następnie można ponownie uruchomić polecenie, `ServiceHost` Aby wznowić normalne przetwarzanie.</span><span class="sxs-lookup"><span data-stu-id="2d941-197">You can then restart `ServiceHost` to resume normal processing.</span></span> <span data-ttu-id="2d941-198">[Obsługa skażonych komunikatów w usłudze MSMQ 4,0](../samples/poison-message-handling-in-msmq-4-0.md) ilustruje to zachowanie.</span><span class="sxs-lookup"><span data-stu-id="2d941-198">The [Poison Message Handling in MSMQ 4.0](../samples/poison-message-handling-in-msmq-4-0.md) demonstrates this behavior.</span></span>  
  
## <a name="transaction-time-out-and-poison-messages"></a><span data-ttu-id="2d941-199">Przekroczenie limitu czasu transakcji i skażonych komunikatów</span><span class="sxs-lookup"><span data-stu-id="2d941-199">Transaction Time-Out and Poison Messages</span></span>  
 <span data-ttu-id="2d941-200">Klasa błędów może wystąpić między kanałem transportu umieszczonym w kolejce a kodem użytkownika.</span><span class="sxs-lookup"><span data-stu-id="2d941-200">A class of errors can occur between the queued transport channel and the user code.</span></span> <span data-ttu-id="2d941-201">Te błędy mogą być wykrywane przez warstwy między, takie jak warstwa zabezpieczeń wiadomości lub logika wysyłania usługi.</span><span class="sxs-lookup"><span data-stu-id="2d941-201">These errors can be detected by layers in-between, such as the message security layer or the service dispatching logic.</span></span> <span data-ttu-id="2d941-202">Na przykład brakuje brakującego certyfikatu X. 509 w warstwie zabezpieczeń protokołu SOAP, a brakująca akcja to przypadki, w których komunikat jest wysyłany do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="2d941-202">For example, a missing X.509 certificate detected in the SOAP security layer and a missing action are cases where the message does get dispatched to the application.</span></span> <span data-ttu-id="2d941-203">W takim przypadku model usługi porzuca komunikat.</span><span class="sxs-lookup"><span data-stu-id="2d941-203">When this happens, the service model drops the message.</span></span> <span data-ttu-id="2d941-204">Ponieważ komunikat jest odczytywany w transakcji i nie można dostarczyć wyniku dla tej transakcji, transakcja zostanie ostatecznie przesunięta w dół, zostanie przerwana, a komunikat zostanie umieszczony w kolejce.</span><span class="sxs-lookup"><span data-stu-id="2d941-204">Because the message is read in a transaction and an outcome for that transaction cannot be provided, the transaction eventually times out, aborts, and the message is put back into the queue.</span></span> <span data-ttu-id="2d941-205">Innymi słowy, w przypadku niektórych klas błędów, transakcja nie jest natychmiast przerywana, ale czeka na przełączenie transakcji. Limit czasu transakcji można zmodyfikować dla usługi przy użyciu programu <xref:System.ServiceModel.ServiceBehaviorAttribute> .</span><span class="sxs-lookup"><span data-stu-id="2d941-205">In other words, for a certain class of errors, the transaction does not immediately abort but waits until the transaction times out. You can modify the transaction time-out for a service using <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span></span>  
  
 <span data-ttu-id="2d941-206">Aby zmienić limit czasu transakcji na poziomie całego komputera, należy zmodyfikować plik Machine. config i ustawić odpowiedni limit czasu transakcji. Należy pamiętać, że w zależności od czasu ustawionego w transakcji transakcja jest ostatecznie przerywana i wraca do kolejki, a jej licznik przerwań jest zwiększany.</span><span class="sxs-lookup"><span data-stu-id="2d941-206">To change the transaction time-out on a computer-wide basis, modify the machine.config file and set the appropriate transaction time-out. It is important to note that, depending on the time-out set in the transaction, the transaction eventually aborts and goes back to the queue and its abort count is incremented.</span></span> <span data-ttu-id="2d941-207">Po pewnym czasie wiadomość jest trująca i odpowiednia Dyspozycja zostanie wprowadzona zgodnie z ustawieniami użytkownika.</span><span class="sxs-lookup"><span data-stu-id="2d941-207">Eventually, the message becomes poison and the right disposition is made according to the user settings.</span></span>  
  
## <a name="sessions-and-poison-messages"></a><span data-ttu-id="2d941-208">Sesje i trujące komunikaty</span><span class="sxs-lookup"><span data-stu-id="2d941-208">Sessions and Poison Messages</span></span>  
 <span data-ttu-id="2d941-209">Sesja przeprowadzi te same procedury obsługi ponowień i komunikatów trujących jako jeden komunikat.</span><span class="sxs-lookup"><span data-stu-id="2d941-209">A session undergoes the same retry and poison-message handling procedures as a single message.</span></span> <span data-ttu-id="2d941-210">Właściwości wymienione wcześniej dla trujących komunikatów mają zastosowanie do całej sesji.</span><span class="sxs-lookup"><span data-stu-id="2d941-210">The properties previously listed for poison messages apply to the entire session.</span></span> <span data-ttu-id="2d941-211">Oznacza to, że cała sesja jest ponawiana i przechodzi do ostatniej kolejki trujących komunikatów lub kolejki utraconych wiadomości nadawcy, jeśli komunikat zostanie odrzucony.</span><span class="sxs-lookup"><span data-stu-id="2d941-211">This means that the entire session is retried and goes to a final poison-message queue or the sender’s dead-letter queue if the message is rejected.</span></span>  
  
## <a name="batching-and-poison-messages"></a><span data-ttu-id="2d941-212">Przetwarzanie wsadowe i trujące komunikaty</span><span class="sxs-lookup"><span data-stu-id="2d941-212">Batching and Poison Messages</span></span>  
 <span data-ttu-id="2d941-213">Jeśli komunikat przejdzie do trującej wiadomości i jest częścią partii, cała partia jest wycofywana, a kanał powróci do odczytu jednej wiadomości w danym momencie.</span><span class="sxs-lookup"><span data-stu-id="2d941-213">If a message becomes a poison message and is part of a batch, then the entire batch is rolled back and the channel returns to reading one message at a time.</span></span> <span data-ttu-id="2d941-214">Aby uzyskać więcej informacji o przetwarzaniu wsadowym, zobacz Tworzenie [wsadowe komunikatów w transakcji](batching-messages-in-a-transaction.md)</span><span class="sxs-lookup"><span data-stu-id="2d941-214">For more information about batching, see [Batching Messages in a Transaction](batching-messages-in-a-transaction.md)</span></span>  
  
## <a name="poison-message-handling-for-messages-in-a-poison-queue"></a><span data-ttu-id="2d941-215">Obsługa komunikatów trujących dla komunikatów w kolejce trującej</span><span class="sxs-lookup"><span data-stu-id="2d941-215">Poison-message Handling for Messages in a Poison Queue</span></span>  
 <span data-ttu-id="2d941-216">Obsługa komunikatów trujących nie kończy się, gdy wiadomość zostanie umieszczona w kolejce trujących komunikatów.</span><span class="sxs-lookup"><span data-stu-id="2d941-216">Poison-message handling does not end when a message is placed in the poison-message queue.</span></span> <span data-ttu-id="2d941-217">Komunikaty w kolejce trujących komunikatów muszą być nadal odczytywane i obsługiwane.</span><span class="sxs-lookup"><span data-stu-id="2d941-217">Messages in the poison-message queue must still be read and handled.</span></span> <span data-ttu-id="2d941-218">Można użyć podzestawu ustawień obsługi komunikatów trujących podczas odczytu komunikatów z podkolejki trującej.</span><span class="sxs-lookup"><span data-stu-id="2d941-218">You can use a subset of the poison-message handling settings when reading messages from the final poison subqueue.</span></span> <span data-ttu-id="2d941-219">Odpowiednie ustawienia to `ReceiveRetryCount` i `ReceiveErrorHandling` .</span><span class="sxs-lookup"><span data-stu-id="2d941-219">The applicable settings are `ReceiveRetryCount` and `ReceiveErrorHandling`.</span></span> <span data-ttu-id="2d941-220">Można ustawić wartość `ReceiveErrorHandling` Drop, Reject lub Fault.</span><span class="sxs-lookup"><span data-stu-id="2d941-220">You can set `ReceiveErrorHandling` to Drop, Reject, or Fault.</span></span> <span data-ttu-id="2d941-221">`MaxRetryCycles`jest ignorowany i występuje wyjątek, jeśli `ReceiveErrorHandling` jest ustawiony do przenoszenia.</span><span class="sxs-lookup"><span data-stu-id="2d941-221">`MaxRetryCycles` is ignored and an exception is thrown if `ReceiveErrorHandling` is set to Move.</span></span>  
  
## <a name="windows-vista-windows-server-2003-and-windows-xp-differences"></a><span data-ttu-id="2d941-222">Różnice w systemach Windows Vista, Windows Server 2003 i Windows XP</span><span class="sxs-lookup"><span data-stu-id="2d941-222">Windows Vista, Windows Server 2003, and Windows XP Differences</span></span>  
 <span data-ttu-id="2d941-223">Jak wspomniano wcześniej, nie wszystkie ustawienia obsługi komunikatów trujących dotyczą systemu Windows Server 2003 i Windows XP.</span><span class="sxs-lookup"><span data-stu-id="2d941-223">As noted earlier, not all poison-message handling settings apply to Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="2d941-224">Następujące kluczowe różnice między usługą kolejkowania komunikatów w systemie Windows Server 2003, Windows XP i Windows Vista mają zastosowanie do obsługi komunikatów trujących:</span><span class="sxs-lookup"><span data-stu-id="2d941-224">The following key differences between Message Queuing on Windows Server 2003, Windows XP, and Windows Vista are relevant to poison-message handling:</span></span>  
  
- <span data-ttu-id="2d941-225">Usługa kolejkowania komunikatów w systemie Windows Vista obsługuje podkolejki, a systemy Windows Server 2003 i Windows XP nie obsługują kolejek.</span><span class="sxs-lookup"><span data-stu-id="2d941-225">Message Queuing in Windows Vista supports subqueues, while Windows Server 2003 and Windows XP do not support subqueues.</span></span> <span data-ttu-id="2d941-226">Kolejki podrzędne są używane w obsłudze komunikatów trujących.</span><span class="sxs-lookup"><span data-stu-id="2d941-226">Subqueues are used in poison-message handling.</span></span> <span data-ttu-id="2d941-227">Kolejki ponawiania prób i kolejka Trująca są podkolejkami do kolejki aplikacji utworzonej na podstawie ustawień obsługi komunikatów trujących.</span><span class="sxs-lookup"><span data-stu-id="2d941-227">The retry queues and the poison queue are subqueues to the application queue that is created based on the poison-message handling settings.</span></span> <span data-ttu-id="2d941-228">`MaxRetryCycles`Określa liczbę podkolejek ponowień do utworzenia.</span><span class="sxs-lookup"><span data-stu-id="2d941-228">The `MaxRetryCycles` dictates how many retry subqueues to create.</span></span> <span data-ttu-id="2d941-229">W związku z tym, gdy działa w systemie Windows Server 2003 lub Windows XP, `MaxRetryCycles` są ignorowane i `ReceiveErrorHandling.Move` nie jest dozwolone.</span><span class="sxs-lookup"><span data-stu-id="2d941-229">Therefore, when running on Windows Server 2003 or Windows XP, `MaxRetryCycles` are ignored and `ReceiveErrorHandling.Move` is not allowed.</span></span>  
  
- <span data-ttu-id="2d941-230">Usługa kolejkowania komunikatów w systemie Windows Vista obsługuje potwierdzenie negatywne, a systemy Windows Server 2003 i Windows XP nie są.</span><span class="sxs-lookup"><span data-stu-id="2d941-230">Message Queuing in Windows Vista supports negative acknowledgment, while Windows Server 2003 and Windows XP do not.</span></span> <span data-ttu-id="2d941-231">Negatywne potwierdzenie od Menedżera kolejki odbiorczej powoduje, że Menedżer kolejki wysyłania umieszcza odrzucony komunikat w kolejce utraconych wiadomości.</span><span class="sxs-lookup"><span data-stu-id="2d941-231">A negative acknowledgment from the receiving queue manager causes the sending queue manager to place the rejected message in the dead-letter queue.</span></span> <span data-ttu-id="2d941-232">W związku `ReceiveErrorHandling.Reject` z tym nie jest dozwolone w przypadku systemów Windows Server 2003 i Windows XP.</span><span class="sxs-lookup"><span data-stu-id="2d941-232">As such, `ReceiveErrorHandling.Reject` is not allowed with Windows Server 2003 and Windows XP.</span></span>  
  
- <span data-ttu-id="2d941-233">Usługa kolejkowania komunikatów w systemie Windows Vista obsługuje Właściwość komunikatu, która zachowuje liczbę prób dostarczenia komunikatu.</span><span class="sxs-lookup"><span data-stu-id="2d941-233">Message Queuing in Windows Vista supports a message property that keeps count of the number of times message delivery is attempted.</span></span> <span data-ttu-id="2d941-234">Ta właściwość liczby przerwań nie jest dostępna w systemach Windows Server 2003 i Windows XP.</span><span class="sxs-lookup"><span data-stu-id="2d941-234">This abort count property is not available on Windows Server 2003 and Windows XP.</span></span> <span data-ttu-id="2d941-235">Funkcja WCF zachowuje liczbę przerwań w pamięci, dlatego jest możliwe, że ta właściwość nie może zawierać dokładnej wartości, gdy ten sam komunikat jest odczytywany przez więcej niż jedną usługę WCF w farmie.</span><span class="sxs-lookup"><span data-stu-id="2d941-235">WCF maintains the abort count in memory, so it is possible that this property may not contain an accurate value when the same message is read by more than one WCF service in a farm.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2d941-236">Zobacz też</span><span class="sxs-lookup"><span data-stu-id="2d941-236">See also</span></span>

- [<span data-ttu-id="2d941-237">Omówienie kolejek</span><span class="sxs-lookup"><span data-stu-id="2d941-237">Queues Overview</span></span>](queues-overview.md)
- [<span data-ttu-id="2d941-238">Różnice w funkcjach kolejkowania w systemach Windows Vista, Windows Server 2003 i Windows XP</span><span class="sxs-lookup"><span data-stu-id="2d941-238">Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP</span></span>](diff-in-queue-in-vista-server-2003-windows-xp.md)
- [<span data-ttu-id="2d941-239">Określanie i obsługa błędów w kontraktach i usługach</span><span class="sxs-lookup"><span data-stu-id="2d941-239">Specifying and Handling Faults in Contracts and Services</span></span>](../specifying-and-handling-faults-in-contracts-and-services.md)
