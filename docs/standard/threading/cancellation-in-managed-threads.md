---
title: Anulowanie w zarządzanych wątkach
description: Zrozumienie anulowania w zarządzanych wątkach. Poznaj tokeny anulowania w ramach spółdzielni anulowania asynchronicznych lub długotrwałych operacji synchronicznych.
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- cancellation in .NET, overview
ms.assetid: eea11fe5-d8b0-4314-bb5d-8a58166fb1c3
ms.openlocfilehash: 9af4a64e50eff65023d5ed5bda868af2f8323a96
ms.sourcegitcommit: 7137e12f54c4e83a94ae43ec320f8cf59c1772ea
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 06/10/2020
ms.locfileid: "84662839"
---
# <a name="cancellation-in-managed-threads"></a><span data-ttu-id="22d3b-104">Anulowanie w zarządzanych wątkach</span><span class="sxs-lookup"><span data-stu-id="22d3b-104">Cancellation in Managed Threads</span></span>
<span data-ttu-id="22d3b-105">Począwszy od .NET Framework 4, .NET Framework korzysta z ujednoliconego modelu do obsługi operacji synchronicznych asynchronicznych lub długotrwałych.</span><span class="sxs-lookup"><span data-stu-id="22d3b-105">Starting with the .NET Framework 4, the .NET Framework uses a unified model for cooperative cancellation of asynchronous or long-running synchronous operations.</span></span> <span data-ttu-id="22d3b-106">Ten model jest oparty na obiekcie lekkim nazywanym tokenem anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-106">This model is based on a lightweight object called a cancellation token.</span></span> <span data-ttu-id="22d3b-107">Obiekt, który wywołuje jedną lub kilka operacji do anulowania, na przykład przez utworzenie nowych wątków lub zadań, przekazuje token do każdej operacji.</span><span class="sxs-lookup"><span data-stu-id="22d3b-107">The object that invokes one or more cancelable operations, for example by creating new threads or tasks, passes the token to each operation.</span></span> <span data-ttu-id="22d3b-108">Poszczególne operacje mogą z kolei przekazywać kopie tokenu do innych operacji.</span><span class="sxs-lookup"><span data-stu-id="22d3b-108">Individual operations can in turn pass copies of the token to other operations.</span></span> <span data-ttu-id="22d3b-109">W późniejszym czasie obiekt, który utworzył token, może go użyć do żądania zatrzymywania wykonywania operacji.</span><span class="sxs-lookup"><span data-stu-id="22d3b-109">At some later time, the object that created the token can use it to request that the operations stop what they are doing.</span></span> <span data-ttu-id="22d3b-110">Tylko obiekt żądający może wydać żądanie anulowania, a każdy odbiornik jest odpowiedzialny za obserwowanie żądania i odpowiadanie na nie w odpowiednim czasie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-110">Only the requesting object can issue the cancellation request, and each listener is responsible for noticing the request and responding to it in an appropriate and timely manner.</span></span>  
  
 <span data-ttu-id="22d3b-111">Ogólny wzorzec dla implementacji spółdzielczego modelu anulowania to:</span><span class="sxs-lookup"><span data-stu-id="22d3b-111">The general pattern for implementing the cooperative cancellation model is:</span></span>  
  
- <span data-ttu-id="22d3b-112">Utworzenie wystąpienia <xref:System.Threading.CancellationTokenSource> obiektu, który zarządza i wysyła powiadomienie o anulowaniu do poszczególnych tokenów anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-112">Instantiate a <xref:System.Threading.CancellationTokenSource> object, which manages and sends cancellation notification to the individual cancellation tokens.</span></span>  
  
- <span data-ttu-id="22d3b-113">Przekaż token zwracany przez <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> Właściwość do każdego zadania lub wątku, który nasłuchuje do anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-113">Pass the token returned by the <xref:System.Threading.CancellationTokenSource.Token%2A?displayProperty=nameWithType> property to each task or thread that listens for cancellation.</span></span>  
  
- <span data-ttu-id="22d3b-114">Udostępnij mechanizm dla każdego zadania lub wątku, aby odpowiedzieć na anulowanie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-114">Provide a mechanism for each task or thread to respond to cancellation.</span></span>  
  
- <span data-ttu-id="22d3b-115">Wywołaj <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> metodę, aby powiadomić o anulowaniu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-115">Call the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method to provide notification of cancellation.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="22d3b-116">Klasa <xref:System.Threading.CancellationTokenSource> implementuje interfejs <xref:System.IDisposable>.</span><span class="sxs-lookup"><span data-stu-id="22d3b-116">The <xref:System.Threading.CancellationTokenSource> class implements the <xref:System.IDisposable> interface.</span></span> <span data-ttu-id="22d3b-117">Należy pamiętać, aby wywołać <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> metodę po zakończeniu korzystania ze źródła tokenu anulowania w celu zwolnienia wszelkich niezarządzanych zasobów, które przechowuje.</span><span class="sxs-lookup"><span data-stu-id="22d3b-117">You should be sure to call the <xref:System.Threading.CancellationTokenSource.Dispose%2A?displayProperty=nameWithType> method when you have finished using the cancellation token source to free any unmanaged resources it holds.</span></span>  
  
 <span data-ttu-id="22d3b-118">Poniższa ilustracja przedstawia relację między źródłem tokenu i wszystkimi kopiami jego tokenu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-118">The following illustration shows the relationship between a token source and all the copies of its token.</span></span>  
  
 <span data-ttu-id="22d3b-119">![Tokeny CancellationTokenSource i anulowania](media/vs-cancellationtoken.png "VS_CancellationToken")</span><span class="sxs-lookup"><span data-stu-id="22d3b-119">![CancellationTokenSource and cancellation tokens](media/vs-cancellationtoken.png "VS_CancellationToken")</span></span>  
  
 <span data-ttu-id="22d3b-120">Nowy model anulowania ułatwia tworzenie aplikacji obsługujących anulowanie i bibliotek oraz obsługę następujących funkcji:</span><span class="sxs-lookup"><span data-stu-id="22d3b-120">The new cancellation model makes it easier to create cancellation-aware applications and libraries, and it supports the following features:</span></span>  
  
- <span data-ttu-id="22d3b-121">Anulowanie jest wspólne i nie jest wymuszane na odbiorniku.</span><span class="sxs-lookup"><span data-stu-id="22d3b-121">Cancellation is cooperative and is not forced on the listener.</span></span> <span data-ttu-id="22d3b-122">Odbiornik Określa, jak bezpiecznie kończyć się w odpowiedzi na żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-122">The listener determines how to gracefully terminate in response to a cancellation request.</span></span>  
  
- <span data-ttu-id="22d3b-123">Żądanie jest różne od nasłuchiwania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-123">Requesting is distinct from listening.</span></span> <span data-ttu-id="22d3b-124">Obiekt, który wywołuje operację do anulowania, może kontrolować, kiedy jest wymagane anulowanie (Jeśli kiedykolwiek).</span><span class="sxs-lookup"><span data-stu-id="22d3b-124">An object that invokes a cancelable operation can control when (if ever) cancellation is requested.</span></span>  
  
- <span data-ttu-id="22d3b-125">Obiekt żądający wysyła żądanie anulowania do wszystkich kopii tokenu przy użyciu tylko jednego wywołania metody.</span><span class="sxs-lookup"><span data-stu-id="22d3b-125">The requesting object issues the cancellation request to all copies of the token by using just one method call.</span></span>  
  
- <span data-ttu-id="22d3b-126">Odbiornik może nasłuchiwać wielu tokenów jednocześnie, łącząc je w jeden *połączony token*.</span><span class="sxs-lookup"><span data-stu-id="22d3b-126">A listener can listen to multiple tokens simultaneously by joining them into one *linked token*.</span></span>  
  
- <span data-ttu-id="22d3b-127">Kod użytkownika może zauważyć i odpowiadać na żądania anulowania z kodu biblioteki, a kod biblioteki może zauważyć żądania anulowania od kodu użytkownika i odpowiadać na nie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-127">User code can notice and respond to cancellation requests from library code, and library code can notice and respond to cancellation requests from user code.</span></span>  
  
- <span data-ttu-id="22d3b-128">Odbiorniki mogą otrzymywać powiadomienia o żądaniach anulowania przez sondowanie, rejestrację wywołania zwrotnego lub oczekiwanie na uchwyty oczekiwania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-128">Listeners can be notified of cancellation requests by polling, callback registration, or waiting on wait handles.</span></span>  
  
## <a name="cancellation-types"></a><span data-ttu-id="22d3b-129">Typy anulowania</span><span class="sxs-lookup"><span data-stu-id="22d3b-129">Cancellation Types</span></span>  
 <span data-ttu-id="22d3b-130">Platforma anulowania jest zaimplementowana jako zestaw powiązanych typów, które są wymienione w poniższej tabeli.</span><span class="sxs-lookup"><span data-stu-id="22d3b-130">The cancellation framework is implemented as a set of related types, which are listed in the following table.</span></span>  
  
|<span data-ttu-id="22d3b-131">Nazwa typu</span><span class="sxs-lookup"><span data-stu-id="22d3b-131">Type name</span></span>|<span data-ttu-id="22d3b-132">Opis</span><span class="sxs-lookup"><span data-stu-id="22d3b-132">Description</span></span>|  
|---------------|-----------------|  
|<xref:System.Threading.CancellationTokenSource>|<span data-ttu-id="22d3b-133">Obiekt, który tworzy token anulowania, a także wystawia żądanie anulowania dla wszystkich kopii tego tokenu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-133">Object that creates a cancellation token, and also issues the cancellation request for all copies of that token.</span></span>|  
|<xref:System.Threading.CancellationToken>|<span data-ttu-id="22d3b-134">Typ wartości uproszczonej przesłany do jednego lub większej liczby detektorów, zazwyczaj jako parametr metody.</span><span class="sxs-lookup"><span data-stu-id="22d3b-134">Lightweight value type passed to one or more listeners, typically as a method parameter.</span></span> <span data-ttu-id="22d3b-135">Odbiorniki monitorują wartość `IsCancellationRequested` właściwości tokenu przez sondowanie, wywołanie zwrotne lub dojście oczekiwania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-135">Listeners monitor the value of the `IsCancellationRequested` property of the token by polling, callback, or wait handle.</span></span>|  
|<xref:System.OperationCanceledException>|<span data-ttu-id="22d3b-136">Przeciążenia konstruktora tego wyjątku akceptują <xref:System.Threading.CancellationToken> jako parametr.</span><span class="sxs-lookup"><span data-stu-id="22d3b-136">Overloads of this exception's constructor accept a <xref:System.Threading.CancellationToken> as a parameter.</span></span> <span data-ttu-id="22d3b-137">Odbiorniki mogą opcjonalnie zgłosić ten wyjątek, aby zweryfikować Źródło anulowania i poinformować inne, że odpowiedział na żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-137">Listeners can optionally throw this exception to verify the source of the cancellation and notify others that it has responded to a cancellation request.</span></span>|  
  
 <span data-ttu-id="22d3b-138">Nowy model anulowania jest zintegrowany z .NET Framework w kilku typach.</span><span class="sxs-lookup"><span data-stu-id="22d3b-138">The new cancellation model is integrated into the .NET Framework in several types.</span></span> <span data-ttu-id="22d3b-139">Najważniejsze są <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType> , <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> i <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="22d3b-139">The most important ones are <xref:System.Threading.Tasks.Parallel?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>, <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span></span> <span data-ttu-id="22d3b-140">Zalecamy używanie tego nowego modelu anulowania dla całej nowej biblioteki i kodu aplikacji.</span><span class="sxs-lookup"><span data-stu-id="22d3b-140">We recommend that you use this new cancellation model for all new library and application code.</span></span>  
  
## <a name="code-example"></a><span data-ttu-id="22d3b-141">Przykład kodu</span><span class="sxs-lookup"><span data-stu-id="22d3b-141">Code Example</span></span>  
 <span data-ttu-id="22d3b-142">W poniższym przykładzie obiekt żądający tworzy <xref:System.Threading.CancellationTokenSource> obiekt, a następnie przekazuje jego <xref:System.Threading.CancellationTokenSource.Token%2A> Właściwość do operacji do anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-142">In the following example, the requesting object creates a <xref:System.Threading.CancellationTokenSource> object, and then passes its <xref:System.Threading.CancellationTokenSource.Token%2A> property to the cancelable operation.</span></span> <span data-ttu-id="22d3b-143">Operacja, która odbiera żądanie, monitoruje wartość <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> właściwości tokenu przez sondowanie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-143">The operation that receives the request monitors the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token by polling.</span></span> <span data-ttu-id="22d3b-144">Gdy wartość stanie się `true` , odbiornik może zakończyć się w dowolny sposób.</span><span class="sxs-lookup"><span data-stu-id="22d3b-144">When the value becomes `true`, the listener can terminate in whatever manner is appropriate.</span></span> <span data-ttu-id="22d3b-145">W tym przykładzie metoda tylko opuszcza, która jest wymagana w wielu przypadkach.</span><span class="sxs-lookup"><span data-stu-id="22d3b-145">In this example, the method just exits, which is all that is required in many cases.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="22d3b-146">W przykładzie zastosowano <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> metodę, aby zademonstrować, że nowa struktura anulowania jest zgodna ze starszymi interfejsami API.</span><span class="sxs-lookup"><span data-stu-id="22d3b-146">The example uses the <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A> method to demonstrate that the new cancellation framework is compatible with legacy APIs.</span></span> <span data-ttu-id="22d3b-147">Aby zapoznać się z przykładem wykorzystującym nowy, preferowany <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> Typ, zobacz [How to: Cancel a Task and jego Children](../parallel-programming/how-to-cancel-a-task-and-its-children.md).</span><span class="sxs-lookup"><span data-stu-id="22d3b-147">For an example that uses the new, preferred <xref:System.Threading.Tasks.Task?displayProperty=nameWithType> type, see [How to: Cancel a Task and Its Children](../parallel-programming/how-to-cancel-a-task-and-its-children.md).</span></span>  
  
 [!code-csharp[Cancellation#1](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex1.cs#1)]
 [!code-vb[Cancellation#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex1.vb#1)]  
  
## <a name="operation-cancellation-versus-object-cancellation"></a><span data-ttu-id="22d3b-148">Anulowanie operacji względem anulowania obiektu</span><span class="sxs-lookup"><span data-stu-id="22d3b-148">Operation Cancellation Versus Object Cancellation</span></span>  
 <span data-ttu-id="22d3b-149">W nowej strukturze anulowania odwołanie odwołuje się do operacji, a nie obiektów.</span><span class="sxs-lookup"><span data-stu-id="22d3b-149">In the new cancellation framework, cancellation refers to operations, not objects.</span></span> <span data-ttu-id="22d3b-150">Żądanie anulowania oznacza, że operacja powinna zostać zatrzymana tak szybko, jak to możliwe po przeprowadzeniu wymaganego oczyszczenia.</span><span class="sxs-lookup"><span data-stu-id="22d3b-150">The cancellation request means that the operation should stop as soon as possible after any required cleanup is performed.</span></span> <span data-ttu-id="22d3b-151">Jeden token anulowania powinien odwoływać się do jednej "operacji możliwej do anulowania", jednak może być zaimplementowana w programie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-151">One cancellation token should refer to one "cancelable operation," however that operation may be implemented in your program.</span></span> <span data-ttu-id="22d3b-152">Po <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> ustawieniu właściwości tokenu na wartość `true` nie można jej resetować do `false` .</span><span class="sxs-lookup"><span data-stu-id="22d3b-152">After the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property of the token has been set to `true`, it cannot be reset to `false`.</span></span> <span data-ttu-id="22d3b-153">W związku z tym tokeny anulowania nie mogą być ponownie używane po anulowaniu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-153">Therefore, cancellation tokens cannot be reused after they have been canceled.</span></span>  
  
 <span data-ttu-id="22d3b-154">Jeśli wymagany jest mechanizm anulowania obiektu, można oprzeć go na mechanizmie anulowania operacji, wywołując <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> metodę, jak pokazano w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-154">If you require an object cancellation mechanism, you can base it on the operation cancellation mechanism by calling the <xref:System.Threading.CancellationToken.Register%2A?displayProperty=nameWithType> method, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#2](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/objectcancellation1.cs#2)]
 [!code-vb[Cancellation#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/objectcancellation1.vb#2)]  
  
 <span data-ttu-id="22d3b-155">Jeśli obiekt obsługuje więcej niż jedną współbieżną operację, należy przekazać oddzielny token jako dane wejściowe do każdej unikatowej operacji anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-155">If an object supports more than one concurrent cancelable operation, pass a separate token as input to each distinct cancelable operation.</span></span> <span data-ttu-id="22d3b-156">Dzięki temu można anulować jedną operację bez wpływu na inne osoby.</span><span class="sxs-lookup"><span data-stu-id="22d3b-156">That way, one operation can be cancelled without affecting the others.</span></span>  
  
## <a name="listening-and-responding-to-cancellation-requests"></a><span data-ttu-id="22d3b-157">Nasłuchiwanie żądań anulowania i reagowanie na nie</span><span class="sxs-lookup"><span data-stu-id="22d3b-157">Listening and Responding to Cancellation Requests</span></span>  
 <span data-ttu-id="22d3b-158">W delegatze użytkownika, realizator operacji anulowania określa sposób kończenia operacji w odpowiedzi na żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-158">In the user delegate, the implementer of a cancelable operation determines how to terminate the operation in response to a cancellation request.</span></span> <span data-ttu-id="22d3b-159">W wielu przypadkach delegat użytkownika może po prostu wykonać wymagane czyszczenie, a następnie natychmiast zwrócić.</span><span class="sxs-lookup"><span data-stu-id="22d3b-159">In many cases, the user delegate can just perform any required cleanup and then return immediately.</span></span>  
  
 <span data-ttu-id="22d3b-160">Jednak w bardziej złożonych przypadkach może być konieczne, aby delegat użytkownika powiadamiał kod biblioteki, że wystąpiło anulowanie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-160">However, in more complex cases, it might be necessary for the user delegate to notify library code that cancellation has occurred.</span></span> <span data-ttu-id="22d3b-161">W takich przypadkach poprawny sposób zakończenia operacji jest przeznaczony dla delegata do wywołania <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A> metody, co spowoduje, że zostanie <xref:System.OperationCanceledException> zgłoszony.</span><span class="sxs-lookup"><span data-stu-id="22d3b-161">In such cases, the correct way to terminate the operation is for the delegate to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A>, method, which will cause an <xref:System.OperationCanceledException> to be thrown.</span></span> <span data-ttu-id="22d3b-162">Kod biblioteki może przechwytywać ten wyjątek w wątku delegata użytkownika i sprawdzać token wyjątku, aby określić, czy wyjątek wskazuje na wcześniejsze anulowanie lub inne wyjątkowe sytuacje.</span><span class="sxs-lookup"><span data-stu-id="22d3b-162">Library code can catch this exception on the user delegate thread and examine the exception's token to determine whether the exception indicates cooperative cancellation or some other exceptional situation.</span></span>  
  
 <span data-ttu-id="22d3b-163"><xref:System.Threading.Tasks.Task>Klasa obsługuje <xref:System.OperationCanceledException> w ten sposób.</span><span class="sxs-lookup"><span data-stu-id="22d3b-163">The <xref:System.Threading.Tasks.Task> class handles <xref:System.OperationCanceledException> in this way.</span></span> <span data-ttu-id="22d3b-164">Aby uzyskać więcej informacji, zobacz [Anulowanie zadania](../parallel-programming/task-cancellation.md).</span><span class="sxs-lookup"><span data-stu-id="22d3b-164">For more information, see [Task Cancellation](../parallel-programming/task-cancellation.md).</span></span>  
  
### <a name="listening-by-polling"></a><span data-ttu-id="22d3b-165">Nasłuchiwanie przez sondowanie</span><span class="sxs-lookup"><span data-stu-id="22d3b-165">Listening by Polling</span></span>  
 <span data-ttu-id="22d3b-166">W przypadku długotrwałych obliczeń, które są wykonywane w pętli lub rekursywnie, można nasłuchiwać żądania anulowania przez okresowe sondowanie wartości <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> właściwości.</span><span class="sxs-lookup"><span data-stu-id="22d3b-166">For long-running computations that loop or recurse, you can listen for a cancellation request by periodically polling the value of the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="22d3b-167">Jeśli wartość to `true` , metoda powinna czyścić i kończyć się tak szybko, jak to możliwe.</span><span class="sxs-lookup"><span data-stu-id="22d3b-167">If its value is `true`, the method should clean up and terminate as quickly as possible.</span></span> <span data-ttu-id="22d3b-168">Optymalna częstotliwość sondowania zależy od typu aplikacji.</span><span class="sxs-lookup"><span data-stu-id="22d3b-168">The optimal frequency of polling depends on the type of application.</span></span> <span data-ttu-id="22d3b-169">Deweloper może określić najlepszą częstotliwość sondowania dla danego programu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-169">It is up to the developer to determine the best polling frequency for any given program.</span></span> <span data-ttu-id="22d3b-170">Sondowanie nie ma znaczącego wpływu na wydajność.</span><span class="sxs-lookup"><span data-stu-id="22d3b-170">Polling itself does not significantly impact performance.</span></span> <span data-ttu-id="22d3b-171">Poniższy przykład pokazuje jeden możliwy sposób sondowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-171">The following example shows one possible way to poll.</span></span>  
  
 [!code-csharp[Cancellation#3](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex11.cs#3)]
 [!code-vb[Cancellation#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex11.vb#3)]  
  
 <span data-ttu-id="22d3b-172">Aby zapoznać się z bardziej kompletnym przykładem, zobacz [jak: nasłuchiwanie żądań anulowania przez sondowanie](how-to-listen-for-cancellation-requests-by-polling.md).</span><span class="sxs-lookup"><span data-stu-id="22d3b-172">For a more complete example, see [How to: Listen for Cancellation Requests by Polling](how-to-listen-for-cancellation-requests-by-polling.md).</span></span>  
  
### <a name="listening-by-registering-a-callback"></a><span data-ttu-id="22d3b-173">Nasłuchiwanie przez zarejestrowanie wywołania zwrotnego</span><span class="sxs-lookup"><span data-stu-id="22d3b-173">Listening by Registering a Callback</span></span>  
 <span data-ttu-id="22d3b-174">Niektóre operacje mogą zostać zablokowane w taki sposób, że nie mogą sprawdzić wartości tokenu anulowania w odpowiednim czasie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-174">Some operations can become blocked in such a way that they cannot check the value of the cancellation token in a timely manner.</span></span> <span data-ttu-id="22d3b-175">W takich przypadkach można zarejestrować metodę wywołania zwrotnego, która odblokowuje metodę po odebraniu żądania anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-175">For these cases, you can register a callback method that unblocks the method when a cancellation request is received.</span></span>  
  
 <span data-ttu-id="22d3b-176"><xref:System.Threading.CancellationToken.Register%2A>Metoda zwraca <xref:System.Threading.CancellationTokenRegistration> obiekt, który jest używany specjalnie do tego celu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-176">The <xref:System.Threading.CancellationToken.Register%2A> method returns a <xref:System.Threading.CancellationTokenRegistration> object that is used specifically for this purpose.</span></span> <span data-ttu-id="22d3b-177">W poniższym przykładzie pokazano, jak za pomocą <xref:System.Threading.CancellationToken.Register%2A> metody anulować asynchroniczne żądanie sieci Web.</span><span class="sxs-lookup"><span data-stu-id="22d3b-177">The following example shows how to use the <xref:System.Threading.CancellationToken.Register%2A> method to cancel an asynchronous Web request.</span></span>  
  
 [!code-csharp[Cancellation#4](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex4.cs#4)]
 [!code-vb[Cancellation#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex4.vb#4)]  
  
 <span data-ttu-id="22d3b-178"><xref:System.Threading.CancellationTokenRegistration>Obiekt zarządza synchronizacją wątków i zapewnia, że wywołanie zwrotne przestanie być wykonywane w określonym momencie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-178">The <xref:System.Threading.CancellationTokenRegistration> object manages thread synchronization and ensures that the callback will stop executing at a precise point in time.</span></span>  
  
 <span data-ttu-id="22d3b-179">Aby zapewnić czas odpowiedzi systemu i uniknąć zakleszczeń, należy przestrzegać następujących wytycznych podczas rejestrowania wywołań zwrotnych:</span><span class="sxs-lookup"><span data-stu-id="22d3b-179">In order to ensure system responsiveness and to avoid deadlocks, the following guidelines must be followed when registering callbacks:</span></span>  
  
- <span data-ttu-id="22d3b-180">Metoda wywołania zwrotnego powinna być szybka, ponieważ jest wywoływana synchronicznie i w związku z tym wywołanie <xref:System.Threading.CancellationTokenSource.Cancel%2A> nie zwraca do momentu powrotu wywołania zwrotnego.</span><span class="sxs-lookup"><span data-stu-id="22d3b-180">The callback method should be fast because it is called synchronously and therefore the call to <xref:System.Threading.CancellationTokenSource.Cancel%2A> does not return until the callback returns.</span></span>  
  
- <span data-ttu-id="22d3b-181">W przypadku wywołania <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> , gdy wywołanie zwrotne jest uruchomione i zatrzymasz blokadę, która oczekuje na wywołanie zwrotne, program może być zakleszczony.</span><span class="sxs-lookup"><span data-stu-id="22d3b-181">If you call <xref:System.Threading.CancellationTokenRegistration.Dispose%2A> while the callback is running, and you hold a lock that the callback is waiting on, your program can deadlock.</span></span> <span data-ttu-id="22d3b-182">Po `Dispose` powrocie można zwolnić wszystkie zasoby wymagane przez wywołanie zwrotne.</span><span class="sxs-lookup"><span data-stu-id="22d3b-182">After `Dispose` returns, you can free any resources required by the callback.</span></span>  
  
- <span data-ttu-id="22d3b-183">Wywołania zwrotne nie powinny wykonywać żadnego wątku ręcznego ani <xref:System.Threading.SynchronizationContext> użycia w wywołaniu zwrotnym.</span><span class="sxs-lookup"><span data-stu-id="22d3b-183">Callbacks should not perform any manual thread or <xref:System.Threading.SynchronizationContext> usage in a callback.</span></span> <span data-ttu-id="22d3b-184">Jeśli wywołanie zwrotne musi zostać uruchomione w określonym wątku, użyj <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> konstruktora, który umożliwia określenie, że element docelowy syncContext jest aktywny <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="22d3b-184">If a callback must run on a particular thread, use the <xref:System.Threading.CancellationTokenRegistration?displayProperty=nameWithType> constructor that enables you to specify that the target syncContext is the active <xref:System.Threading.SynchronizationContext.Current%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="22d3b-185">Ręczne wykonywanie wątków w wywołaniu zwrotnym może spowodować zakleszczenie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-185">Performing manual threading in a callback can cause deadlock.</span></span>  
  
 <span data-ttu-id="22d3b-186">Aby zapoznać się z bardziej kompletnym przykładem, zobacz [jak: rejestrowanie wywołań zwrotnych żądań anulowania](how-to-register-callbacks-for-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="22d3b-186">For a more complete example, see [How to: Register Callbacks for Cancellation Requests](how-to-register-callbacks-for-cancellation-requests.md).</span></span>  
  
### <a name="listening-by-using-a-wait-handle"></a><span data-ttu-id="22d3b-187">Nasłuchiwanie przy użyciu dojścia oczekiwania</span><span class="sxs-lookup"><span data-stu-id="22d3b-187">Listening by Using a Wait Handle</span></span>  
 <span data-ttu-id="22d3b-188">Gdy operacja, którą można anulować, może blokować, gdy oczekuje na element pierwotny synchronizacji, taki jak <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> lub <xref:System.Threading.Semaphore?displayProperty=nameWithType> , można użyć <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> właściwości, aby umożliwić operacji oczekiwania na zdarzenie i żądanie anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-188">When a cancelable operation can block while it waits on a synchronization primitive such as a <xref:System.Threading.ManualResetEvent?displayProperty=nameWithType> or <xref:System.Threading.Semaphore?displayProperty=nameWithType>, you can use the <xref:System.Threading.CancellationToken.WaitHandle%2A?displayProperty=nameWithType> property to enable the operation to wait on both the event and the cancellation request.</span></span> <span data-ttu-id="22d3b-189">Dojście oczekiwania tokenu anulowania zostanie sygnalizowane w odpowiedzi na żądanie anulowania, a metoda może użyć wartości zwracanej przez <xref:System.Threading.WaitHandle.WaitAny%2A> metodę, aby określić, czy był to token anulowania, który zasygnalizuje.</span><span class="sxs-lookup"><span data-stu-id="22d3b-189">The wait handle of the cancellation token will become signaled in response to a cancellation request, and the method can use the return value of the <xref:System.Threading.WaitHandle.WaitAny%2A> method to determine whether it was the cancellation token that signaled.</span></span> <span data-ttu-id="22d3b-190">Operacja może po prostu zakończyć lub zgłosić <xref:System.OperationCanceledException> , zgodnie z potrzebami.</span><span class="sxs-lookup"><span data-stu-id="22d3b-190">The operation can then just exit, or throw a <xref:System.OperationCanceledException>, as appropriate.</span></span>  
  
 [!code-csharp[Cancellation#5](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex9.cs#5)]
 [!code-vb[Cancellation#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex9.vb#5)]  
  
 <span data-ttu-id="22d3b-191">W nowym kodzie, który jest przeznaczony dla .NET Framework 4 <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> i <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> obie wersje obsługują nową strukturę anulowania w ich `Wait` metodach.</span><span class="sxs-lookup"><span data-stu-id="22d3b-191">In new code that targets the .NET Framework 4, <xref:System.Threading.ManualResetEventSlim?displayProperty=nameWithType> and <xref:System.Threading.SemaphoreSlim?displayProperty=nameWithType> both support the new cancellation framework in their `Wait` methods.</span></span> <span data-ttu-id="22d3b-192">Można przekazać <xref:System.Threading.CancellationToken> do metody, a po zażądaniu anulowania zdarzenie zostanie wznowione i wygeneruje <xref:System.OperationCanceledException> .</span><span class="sxs-lookup"><span data-stu-id="22d3b-192">You can pass the <xref:System.Threading.CancellationToken> to the method, and when the cancellation is requested, the event wakes up and throws an <xref:System.OperationCanceledException>.</span></span>  
  
 [!code-csharp[Cancellation#6](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex10.cs#6)]
 [!code-vb[Cancellation#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex10.vb#6)]  
  
 <span data-ttu-id="22d3b-193">Aby zapoznać się z bardziej kompletnym przykładem, zobacz [jak: nasłuchiwanie żądań anulowania z dojściami oczekiwania](how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span><span class="sxs-lookup"><span data-stu-id="22d3b-193">For a more complete example, see [How to: Listen for Cancellation Requests That Have Wait Handles](how-to-listen-for-cancellation-requests-that-have-wait-handles.md).</span></span>  
  
### <a name="listening-to-multiple-tokens-simultaneously"></a><span data-ttu-id="22d3b-194">Jednoczesne nasłuchiwanie wielu tokenów</span><span class="sxs-lookup"><span data-stu-id="22d3b-194">Listening to Multiple Tokens Simultaneously</span></span>  
 <span data-ttu-id="22d3b-195">W niektórych przypadkach odbiornik może chcieć nasłuchiwać wielu tokenów anulowania jednocześnie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-195">In some cases, a listener may have to listen to multiple cancellation tokens simultaneously.</span></span> <span data-ttu-id="22d3b-196">Na przykład operacja anulowania może być konieczne do monitorowania wewnętrznego tokenu anulowania oprócz tokenu przesyłanego zewnętrznie jako argumentu do parametru metody.</span><span class="sxs-lookup"><span data-stu-id="22d3b-196">For example, a cancelable operation may have to monitor an internal cancellation token in addition to a token passed in externally as an argument to a method parameter.</span></span> <span data-ttu-id="22d3b-197">Aby to osiągnąć, Utwórz źródło połączonego tokenu, które może dołączyć dwa lub więcej tokenów do jednego tokenu, jak pokazano w poniższym przykładzie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-197">To accomplish this, create a linked token source that can join two or more tokens into one token, as shown in the following example.</span></span>  
  
 [!code-csharp[Cancellation#7](../../../samples/snippets/csharp/VS_Snippets_Misc/cancellation/cs/cancellationex13.cs#7)]
 [!code-vb[Cancellation#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/cancellation/vb/cancellationex13.vb#7)]  
  
 <span data-ttu-id="22d3b-198">Zwróć uwagę, że `Dispose` po wykonaniu tej czynności należy wywołać Źródło połączonego tokenu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-198">Notice that you must call `Dispose` on the linked token source when you are done with it.</span></span> <span data-ttu-id="22d3b-199">Aby zapoznać się z bardziej kompletnym przykładem, zobacz [jak: nasłuchiwanie wielu żądań anulowania](how-to-listen-for-multiple-cancellation-requests.md).</span><span class="sxs-lookup"><span data-stu-id="22d3b-199">For a more complete example, see [How to: Listen for Multiple Cancellation Requests](how-to-listen-for-multiple-cancellation-requests.md).</span></span>  
  
## <a name="cooperation-between-library-code-and-user-code"></a><span data-ttu-id="22d3b-200">Współpraca między kodem biblioteki i kodem użytkownika</span><span class="sxs-lookup"><span data-stu-id="22d3b-200">Cooperation Between Library Code and User Code</span></span>  
 <span data-ttu-id="22d3b-201">Ujednolicona platforma anulowania pozwala na kod biblioteki, aby anulować kod użytkownika, a kod użytkownika w celu anulowania kodu biblioteki w sposób współpracy.</span><span class="sxs-lookup"><span data-stu-id="22d3b-201">The unified cancellation framework makes it possible for library code to cancel user code, and for user code to cancel library code in a cooperative manner.</span></span> <span data-ttu-id="22d3b-202">Bezproblemowa współpraca zależy od następujących wskazówek:</span><span class="sxs-lookup"><span data-stu-id="22d3b-202">Smooth cooperation depends on each side following these guidelines:</span></span>  
  
- <span data-ttu-id="22d3b-203">Jeśli kod biblioteki zapewnia operacje, które można anulować, powinien również dostarczyć metody publiczne, które akceptują Zewnętrzny token anulowania, aby kod użytkownika mógł żądać anulowania.</span><span class="sxs-lookup"><span data-stu-id="22d3b-203">If library code provides cancelable operations, it should also provide public methods that accept an external cancellation token so that user code can request cancellation.</span></span>  
  
- <span data-ttu-id="22d3b-204">Jeśli kod biblioteki wywołuje kod użytkownika, kod biblioteki powinien interpretować OperationCanceledException (externalToken) jako *spółdzielnie anulowania*i niekoniecznie jako wyjątek błędu.</span><span class="sxs-lookup"><span data-stu-id="22d3b-204">If library code calls into user code, the library code should interpret an OperationCanceledException(externalToken) as *cooperative cancellation*, and not necessarily as a failure exception.</span></span>  
  
- <span data-ttu-id="22d3b-205">Delegaty użytkownika powinni próbować odpowiedzieć na żądania anulowania z kodu biblioteki w odpowiednim czasie.</span><span class="sxs-lookup"><span data-stu-id="22d3b-205">User-delegates should attempt to respond to cancellation requests from library code in a timely manner.</span></span>  
  
 <span data-ttu-id="22d3b-206"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType>i <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> są przykładami klas, które są zgodne z tymi wskazówkami.</span><span class="sxs-lookup"><span data-stu-id="22d3b-206"><xref:System.Threading.Tasks.Task?displayProperty=nameWithType> and <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> are examples of classes that follow these guidelines.</span></span> <span data-ttu-id="22d3b-207">Aby uzyskać więcej informacji, zobacz [Anulowanie zadania](../parallel-programming/task-cancellation.md) i [instrukcje: anulowanie zapytania PLINQ](../parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="22d3b-207">For more information, see [Task Cancellation](../parallel-programming/task-cancellation.md) and [How to: Cancel a PLINQ Query](../parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="22d3b-208">Zobacz także</span><span class="sxs-lookup"><span data-stu-id="22d3b-208">See also</span></span>

- [<span data-ttu-id="22d3b-209">Zarządzana wątkowość — podstawy</span><span class="sxs-lookup"><span data-stu-id="22d3b-209">Managed Threading Basics</span></span>](managed-threading-basics.md)
